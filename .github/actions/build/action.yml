name: Build plugin
description: 'Builds, tests, and packages the plugin'

outputs:
  plugin-id:
    description: 'The plugin ID'
    value: ${{ steps.metadata.outputs.plugin-id }}
  plugin-version:
    description: 'The plugin version'
    value: ${{ steps.metadata.outputs.plugin-version }}
  archive:
    description: 'The packaged and signed plugin artifact'
    value: ${{ steps.metadata.outputs.archive }}

inputs:
  policy_token:
    description: 'Grafana access policy token. https://grafana.com/developers/plugin-tools/publish-a-plugin/sign-a-plugin#generate-an-access-policy-token'
    required: true
    default: ''

runs:
  using: 'composite'
  steps:
    - uses: actions/checkout@v4
      # Only build and release if the repository is grafana/metrics-drilldown (not a fork)
      if: github.repository == 'grafana/metrics-drilldown'

    - name: Setup Node.js environment
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'

    - name: Install dependencies
      shell: bash
      run: npm ci

      - name: Get current commit SHA
        id: get_sha
        run: echo "commit_sha=$(git rev-parse HEAD)" >> $GITHUB_ENV

      # Before building make sure we update the version so it's easy to identify it
      # We need to get correct sha in the step above in cases when we are building a tag
      # For PR however we need to use github.event.pull_request.head.sha because env.commit_sha would point
      # to a commit for merge with main commit (branch is synced with main to check for conflicts)
      # see also https://github.com/orgs/community/discussions/25318
      - name: Update version.ts
        run: echo "export const GIT_COMMIT = '${{ github.event.pull_request.head.sha || env.commit_sha }}';" > src/version.ts

    - name: Build frontend
      shell: bash
      run: |
        if { [ "${{ github.event_name }}" == "push" ] || [ "${{ github.event_name }}" == "workflow_run" ]; } && [ "${{ github.ref }}" == "refs/heads/main" ]; then
          npm run build -- --profile --json stats.json
        else
          npm run build
        fi

    - name: Sign plugin
      run: npm run sign
      shell: bash
      env:
        GRAFANA_ACCESS_POLICY_TOKEN: ${{ inputs.policy_token }}

    - name: Get plugin metadata
      id: metadata
      shell: bash
      run: |
        sudo apt-get install jq

        export GRAFANA_PLUGIN_ID=$(cat dist/plugin.json | jq -r .id)
        export GRAFANA_PLUGIN_VERSION=$(cat dist/plugin.json | jq -r .info.version)
        export GRAFANA_PLUGIN_ARTIFACT=${GRAFANA_PLUGIN_ID}-latest.zip

        echo "plugin-id=${GRAFANA_PLUGIN_ID}" >> $GITHUB_OUTPUT
        echo "plugin-version=${GRAFANA_PLUGIN_VERSION}" >> $GITHUB_OUTPUT
        echo "archive=${GRAFANA_PLUGIN_ARTIFACT}" >> $GITHUB_OUTPUT

        echo "archive=${GRAFANA_PLUGIN_ARTIFACT}"

    - name: Package plugin
      id: package-plugin
      shell: bash
      run: |
        mv dist ${{ steps.metadata.outputs.plugin-id }}
        zip ${{ steps.metadata.outputs.archive }} ${{ steps.metadata.outputs.plugin-id }} -r

    - name: Archive Build
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.metadata.outputs.archive }}
        path: ${{ steps.metadata.outputs.archive }}
        retention-days: 5
